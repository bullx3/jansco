<div class='playersocred'>

<h1>プレイヤー個人成績</h1>

<%= form_tag({action: :scored}, method: :get, id: 'form_select_player') do %>
<p>
	<%= label_tag :player_id, 'プレイヤー選択' %>
	<%= collection_select(:player, :id, @players, :id, :name, {include_blank: '選択してください', selected: @player_id}, onchange: 'changeSelectPlayer(this)') %>
</p>

<p>
	<%= label_tag :date_check_start, '集計開始日時' %>
	<%= check_box :date_check, :start, {checked: @checkedStart, id: :date_check_start ,onchange: "onchangeCheckbox(this,'start')"} %>
	<%= date_field(:date, :start, {disabled: !(@checkedStart), value: @date_start,onblur: "changeDate(this, 'start')"})  %>
</p>
<p>
	<%= label_tag :date_check_end, '集計終了日時' %>
	<%= check_box :date_check, :end, {checked: @checkedEnd, id: :date_check_end ,onchange: "onchangeCheckbox(this,'end')"} %>
	<%= date_field(:date, :end, {disabled: !(@checkedEnd), value: @date_end, onblur: "changeDate(this, 'end')"})  %>
</p>

<div class='comments'>
※ 集計開始日時は指定した日付の12:00(正午)から、集計終了日時は指定した日付の次の日の11:59までに'ゲーム終了'を行ったゲームのみを集計します。
(半荘のデータを入力していても'ゲーム終了'を行っていない限り集計されません)
<br>
例) 開始を2018/8/1、 終了を8/31にした場合、8/1 12:00 ～ 9/1 11:59を集計します
</div>
<% end %>

<hr>


<% unless @player_id.nil? %>

<h3><%= @player_name %>成績</h3>

<table class='scoredTable1'>
	<captain>合計スコア</captain>
	<tr>
		<th>合計</th>
		<th>四麻</th>
		<th>三麻</th>
		<th>チップ</th>
	</tr>
	<tr>
		<% if @total_score >= 0  %>
			<td><%= @total_score %></td>
		<% else %>
			<td><span class='minus_number' ><%= @total_score %></span></td>
		<% end %>
		<% if @m4_score >= 0  %>
			<td><%= @m4_score %></td>
		<% else %>
			<td><span class='minus_number' ><%= @m4_score %></span></td>
		<% end %>
		<% if @m3_score >= 0  %>
			<td><%= @m3_score %></td>
		<% else %>
			<td><span class='minus_number' ><%= @m3_score %></span></td>
		<% end %>
		<% if @chip_score >= 0  %>
			<td><%= @chip_score %></td>
		<% else %>
			<td><span class='minus_number' ><%= @chip_score %></span></td>
		<% end %>
	</tr>
</table>

<br>

<table class='scoredTable1'>
	<captain>四麻の順位数</captain>
	<tr>
		<th>対局数</th>
		<th>１位</th>
		<th>２位</th>
		<th>３位</th>
		<th>４位</th>
	</tr>
	<tr>
		<td><%= @m4_games.length %></td>
		<% @m4_ranks.each do |count| %>
			<td><%= count %></td>
		<% end %>
	</tr>

</table>

<br>


<table class='scoredTable1'>
	<captain>三麻の順位数</captain>
	<tr>
		<th>対局数</th>
		<th>１位</th>
		<th>２位</th>
		<th>３位</th>
	</tr>
	<tr>
		<td><%= @m3_games.length %></td>
		<% @m3_ranks.each do |count| %>
			<td><%= count %></td>
		<% end %>
	</tr>

</table>

<br>


<hr>

<h4>四麻の戦績</h4>
<% if @m4_games.length > 0 %>
	<%= render 'scoredTable' , rank_count: 4, games: @m4_games , player_ids: [@player_id] %>

<% else %>
	四麻の戦績はありません
<% end %>

<hr>

<h4>三麻の戦績</h4>
<% if @m3_games.length > 0 %>
	<%= render 'scoredTable' , rank_count: 3, games: @m3_games , player_ids: [@player_id] %>
<% else %>
	三麻の戦績はありません
<% end %>


<hr>

<% end %>





<h2>
	<%= link_to '個人成績トップに戻る', action: :index %>
</h2>

</div>

<script>
	var formElement = document.getElementById('form_select_player')
	var selectPlayerElement = document.getElementById('player_id')
	var checkStartElement = document.getElementById('date_check_start')
	var checkEndElement = document.getElementById('date_check_end')
	var dateStartElement = document.getElementById('date_start')
	var dateEndElement = document.getElementById('date_end')

	var bak_date_start = dateStartElement.value
	var bak_date_end = dateEndElement.value

	function changeSelectPlayer(obj){
		var idx = obj.selectedIndex;
		var value = obj.options[idx].value;
		console.log(value);
		changeDateSubmit()
	}



	function onchangeCheckbox(obj, kind){
		console.log(kind);
		console.log(obj.checked);
		if(kind == 'start'){
			if(obj.checked){
				dateStartElement.disabled = false
			}else{
				dateStartElement.disabled = true
				startDate = dateStartElement.value
				if (startDate){
					// チェック状態が外れた時間が入力されていたら解除ということでsubmitする
					changeDateSubmit()
				}
			}
		}else if(kind == 'end'){
			if(obj.checked){
				dateEndElement.disabled = false
			}else{
				dateEndElement.disabled = true
				endDate = dateEndElement.value
				if (endDate){
					// チェック状態が外れた時間が入力されていたら解除ということでsubmitする
					changeDateSubmit()
				}
			}
		}
	}

	function changeDate(obj, kind){
		console.log(kind);
		console.log(obj.value);

		if (kind == 'start'){
			if (bak_date_start == obj.value){
				return
			}
			bak_date_start = obj.value

		}else{
			if (bak_date_start == obj.value){
				return
			}
			bak_date_end = obj.value
		}


		changeDateSubmit()
	}

	function changeDateSubmit(){
		startDate = dateStartElement.value
		endDate = dateEndElement.value

		if (checkStartElement.checked && startDate
			&& checkEndElement.checked && endDate){
				if (startDate > endDate){
					alert('集計終了日時は集計開始日時より遅くしてください')
					return
				}
		}
		console.log('submitします');
		formElement.submit()

	}

</script>
